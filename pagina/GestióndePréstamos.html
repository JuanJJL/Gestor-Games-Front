<!-- Página 3: prestamos.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Préstamos</title>
  <link rel="stylesheet" href="estilotrespaginas.css">
</head>
<body>
  <header>
    <h1>Gestión de Préstamos</h1>
    <nav>
      <a href="GestióndeVideojuegos.html">Videojuegos</a>
      <a href="GestióndeUsuarios.html">Usuarios</a>
      <a href="GestióndePréstamos.html">Préstamos</a>
    </nav>
  </header>
  <main>
    <section>
            <h2>Registrar Préstamo</h2>
            <form id="formRegistrarPrestamo">
                <div class="form-group">
                    <label for="videojuegoId">ID Videojuego:</label>
                    <input type="number" id="videojuegoId" placeholder="ID Videojuego" required>
                </div>
                <div class="form-group">
                    <label for="clienteId">ID Cliente:</label>
                    <input type="number" id="clienteId" placeholder="ID Cliente" required>
                </div>
                <div class="form-group">
                    <label for="fechaDevolucion">Fecha límite de devolución:</label>
                    <input type="date" id="fechaDevolucion" required>
                </div>
                <div class="form-group">
                    <label for="totalPrestamo">Total del Préstamo:</label>
                    <input type="number" id="totalPrestamo" step="0.01" placeholder="Ej: 5.00" required>
                </div>
                <button type="submit">Registrar préstamo</button>
            </form>
            <div id="messageContainer" class="message-container" style="display: none;"></div>
        </section>
    <section>
      <h2>Lista de Préstamos</h2>
      <table>
        <thead>
          <tr>
            <th>Videojuego</th><th>Cliente</th><th>Fecha préstamo</th><th>Fecha devolución</th><th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Juego 1</td><td>Ana López</td><td>2025-07-06</td><td>2025-07-13</td><td>Pendiente</td>
            <td><button>Devolver</button></td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>
</body>
  <script>

        const $ = (el) => document.queryselector(el);
        const formRegistrarPrestamo = $('formRegistrarPrestamo');
        const videojuegoIdInput = $('#videojuegoId');
        const clienteIdInput = $('#clienteId');
        const fechaDevolucionInput = $('#fechaDevolucion');
        const totalPrestamoInput = $('#totalPrestamo');
        const messageContainer = $('#messageContainer');

        const BACKEND_URL = 'http://localhost:8080/api/loans';

  
        function showMessage(message, type) {
            messageContainer.textContent = message;
            messageContainer.className = `message-container message-${type}`;
            messageContainer.style.display = 'block';

            // Ocultar el mensaje después de 5 segundos
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }
        async function registrarPrestamoBackend(datosPrestamo) {
            try {
                const respuesta = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Indicar que el cuerpo de la solicitud es JSON
                    },
                    body: JSON.stringify(datosPrestamo) // Convertir el objeto JavaScript a una cadena JSON
                });
              if (respuesta.ok) {
                    const resultado = await respuesta.json(); // Parsear la respuesta JSON del backend
                    console.log('Préstamo registrado con éxito:', resultado);
                    showMessage('Préstamo registrado con éxito.', 'success');
                    formRegistrarPrestamo.reset(); // Limpiar el formulario después del éxito
                } else {
                    const errorData = await respuesta.json(); // Asume que el backend envía errores en JSON
                    const errorMessage = errorData.message || 'Error desconocido al registrar el préstamo.';
                    console.error('Error al registrar el préstamo:', respuesta.status, errorData);
                    showMessage(`Error: ${errorMessage}`, 'error');
                }
            } catch (error) {
                // Capturar errores de red o cualquier otro error durante la solicitud
                console.error('Error de conexión o inesperado:', error);
                showMessage('Error de conexión con el servidor. Inténtalo de nuevo.', 'error');
            }
        }


        submitButton.addEventListener('click', async (e) => {
            e.preventDefault(); // Prevenir el envío del formulario por defecto el cual es recargar la página

            // Ocultar cualquier mensaje anterior y resetear clases de error
            messageContainer.classList.add('message-invisible');
            messageContainer.style.display = 'none';

            // 1. Obtener los valores de los campos del formulario
            const videojuegoId = videojuegoIdInput.value.trim(); // .trim() para quitar espacios en blanco
            const clienteId = clienteIdInput.value.trim();
            const fechaDevolucion = fechaDevolucionInput.value.trim();
            const totalPrestamo = totalPrestamoInput.value.trim();

            
            if (videojuegoId === '') {
                showMessage("El ID del Videojuego es obligatorio.", 'error');
                return; // Detener la ejecución si hay un error de validación
            }
            if (isNaN(parseInt(videojuegoId))) {
                 showMessage("El ID del Videojuego debe ser un número.", 'error');
                 return;
            }

            if (clienteId === '') {
                showMessage("El ID del Cliente es obligatorio.", 'error');
                return;
            }
            if (isNaN(parseInt(clienteId))) {
                 showMessage("El ID del Cliente debe ser un número.", 'error');
                 return;
            }

            if (fechaDevolucion === '') {
                showMessage("La Fecha de Devolución es obligatoria.", 'error');
                return;
            }
            // Validación de fecha básica (formato YYYY-MM-DD)
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/; //verifica que tenga la cantidad de digitos (d) necesarios
            if (!dateRegex.test(fechaDevolucion)) {
                showMessage("La Fecha de Devolución no tiene un formato válido (YYYY-MM-DD).", 'error');
                return;
            }

            if (totalPrestamo === '') {
                showMessage("El Total del Préstamo es obligatorio.", 'error');
                return;
            }
            if (isNaN(parseFloat(totalPrestamo))) {
                showMessage("El Total del Préstamo debe ser un número.", 'error');
                return;
            }


            // Si todas las validaciones pasan, preparar los datos y llamar a la función de envío
            const now = new Date();
            const fechaPrestamo = now.toISOString().slice(0, 19).replace('T', ' '); //el .slice(0, 19) elimina los milisegundos y se remplaza luego la t por un espacio

            const datosPrestamo = {
                id_juego: parseInt(videojuegoId),
                id_usuario: parseInt(clienteId),
                fecha_prestamo: fechaPrestamo,
                fin_prestamo: fechaDevolucion, // Se asume que el backend gestionará la hora de fin si es necesario
                total: parseFloat(totalPrestamo)
            };

            // Llamar a la función que maneja el envío al backend
            await registrarPrestamoBackend(datosPrestamo);
        });
    </script>
</html>
