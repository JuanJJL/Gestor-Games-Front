<!-- Página 3: prestamos.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Préstamos</title>
  <link rel="stylesheet" href="estilotrespaginas.css">
</head>
<body>
  <header>
    <h1>Gestión de Préstamos</h1>
    <nav>
      <a href="GestióndeVideojuegos.html">Videojuegos</a>
      <a href="GestióndeUsuarios.html">Usuarios</a>
      <a href="GestióndePréstamos.html">Préstamos</a>
    </nav>
  </header>
  <main>
    <section>
            <h2>Registrar Préstamo</h2>
            <form id="formRegistrarPrestamo">
                <div class="form-group">
                    <label for="videojuegoId">ID Videojuego:</label>
                    <input type="number" id="videojuegoId" placeholder="ID Videojuego" required>
                </div>
                <div class="form-group">
                    <label for="clienteId">ID Cliente:</label>
                    <input type="number" id="clienteId" placeholder="ID Cliente" required>
                </div>
                <div class="form-group">
                    <label for="fechaDevolucion">Fecha límite de devolución:</label>
                    <input type="date" id="fechaDevolucion" required>
                </div>
                <div class="form-group">
                    <label for="totalPrestamo">Total del Préstamo:</label>
                    <input type="number" id="totalPrestamo" step="0.01" placeholder="Ej: 5.00" required>
                </div>
                <button type="submit">Registrar préstamo</button>
            </form>
            <div id="messageContainer" class="message-container" style="display: none;"></div>
        </section>
    <section>
      <h2>Lista de Préstamos</h2>
      <table>
        <thead>
          <tr>
            <th>Videojuego</th><th>Cliente</th><th>Fecha préstamo</th><th>Fecha devolución</th><th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Juego 1</td><td>Ana López</td><td>2025-07-06</td><td>2025-07-13</td><td>Pendiente</td>
            <td><button>Devolver</button></td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>
</body>
  <script>
        const formRegistrarPrestamo = document.getElementById('formRegistrarPrestamo');
        const videojuegoIdInput = document.getElementById('videojuegoId');
        const clienteIdInput = document.getElementById('clienteId');
        const fechaDevolucionInput = document.getElementById('fechaDevolucion');
        const totalPrestamoInput = document.getElementById('totalPrestamo');
        const messageContainer = document.getElementById('messageContainer');

        const BACKEND_URL = 'http://localhost:8080/api/loans';

  
        @param {string} message - El mensaje a mostrar.
        @param {string} type - El tipo de mensaje ('success' o 'error').
          
        function showMessage(message, type) {
            messageContainer.textContent = message;
            messageContainer.className = `message-container message-${type}`;
            messageContainer.style.display = 'block';

            // Ocultar el mensaje después de 5 segundos
            setTimeout(() => {
                messageContainer.style.display = 'none';
            }, 5000);
        }

        // Añadir un "escuchador de eventos" al formulario para cuando se envíe
        formRegistrarPrestamo.addEventListener('submit', async (event) => {
            // Prevenir la recargar de la página)
            event.preventDefault();

            // Obtener los valores de los campos del formulario
            const videojuegoId = parseInt(videojuegoIdInput.value); 
            const clienteId = parseInt(clienteIdInput.value);       
            const fechaDevolucion = fechaDevolucionInput.value;     
            const totalPrestamo = parseFloat(totalPrestamoInput.value); 

            // Obtener la fecha actual para fecha_prestamo
            const now = new Date();
            // Formatear la fecha y hora actual a un formato ISO para que el backend entienda melo
            const fechaPrestamo = now.toISOString().slice(0, 19).replace('T', ' ');

            // Crear un objeto JavaScript con los datos del préstamo
            const datosPrestamo = {
                id_juego: videojuegoId,
                id_usuario: clienteId,
                fecha_prestamo: fechaPrestamo,
                fin_prestamo: fechaDevolucion,
                total: totalPrestamo
            };

            console.log('Datos a enviar:', datosPrestamo); 

            try {
                // Realizar la solicitud POST al backend usando fetch
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // Indicar que el cuerpo de la solicitud es JSON
                    },
                    body: JSON.stringify(datosPrestamo) // Convertir el objeto JavaScript a una cadena JSON
                });

                if (response.ok) {
                    const resultado = await response.json(); // Parsear la respuesta JSON del backend
                    console.log('Préstamo registrado con éxito:', resultado);
                    showMessage('Préstamo registrado con éxito.', 'success');
                    formRegistrarPrestamo.reset(); // Limpiar el formulario después del éxito
                  
                } else {
                    const errorData = await response.json(); // Asume que el backend envía errores en JSON
                    const errorMessage = errorData.message || 'Error al registrar el préstamo.';
                    console.error('Error al registrar el préstamo:', response.status, errorData);
                    showMessage(`Error: ${errorMessage}`, 'error');
                }
            } catch (error) {
                // Capturar errores de red o cualquier otro error durante la solicitud
                console.error('Error de conexión o inesperado:', error);
                showMessage('Error de conexión. Inténtalo de nuevo más tarde.', 'error');
            }
        });
    </script>
</html>
